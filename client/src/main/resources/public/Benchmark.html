<!DOCTYPE html>
<html>
<head>
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .benchmark-card { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .metric-card { background: #f5f5f5; padding: 15px; border-radius: 4px; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        .chart-container { margin-top: 20px; height: 300px; }

        /* Spinner styles */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            display: none;
            margin-left: 10px;
            vertical-align: middle;
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
</head>
<body>
<div class="container">
    <!-- Combined benchmark button -->
    <button onclick="runCombinedBenchmark()" id="combinedButton">
        Run Both Benchmarks
        <span id="combinedSpinner" class="loading-container">
                <span class="spinner"></span>
            </span>
    </button>

    <div class="benchmark-card">
        <h2>Hazelcast Benchmark</h2>
        <div class="form-group">
            <label for="hazelcastRequests">Number of Requests:</label>
            <input type="number" id="hazelcastRequests" value="100">
        </div>
        <button onclick="runBenchmark('hazelcast')" id="hazelcastButton">
            Run Benchmark
            <span id="hazelcastSpinner" class="loading-container">
                    <span class="spinner"></span>
                </span>
        </button>
        <div id="hazelcastResults" class="results"></div>
        <div class="chart-container">
            <canvas id="hazelcastChart"></canvas>
        </div>
    </div>

    <div class="benchmark-card">
        <h2>Redis Benchmark</h2>
        <div class="form-group">
            <label for="redisRequests">Number of Requests:</label>
            <input type="number" id="redisRequests" value="100">
        </div>
        <button onclick="runBenchmark('redis')" id="redisButton">
            Run Benchmark
            <span id="redisSpinner" class="loading-container">
                    <span class="spinner"></span>
                </span>
        </button>
        <div id="redisResults" class="results"></div>
        <div class="chart-container">
            <canvas id="redisChart"></canvas>
        </div>
    </div>
</div>

<script>
    let charts = { hazelcast: null, redis: null };

    function showSpinner(cacheType) {
        const spinner = document.getElementById(`${cacheType}Spinner`);
        if (spinner) spinner.style.display = 'inline-block';
    }

    function hideSpinner(cacheType) {
        const spinner = document.getElementById(`${cacheType}Spinner`);
        if (spinner) spinner.style.display = 'none';
    }

    async function runBenchmark(cacheType) {
        const button = document.getElementById(`${cacheType}Button`);
        const requestsInput = document.getElementById(`${cacheType}Requests`);
        const resultsDiv = document.getElementById(`${cacheType}Results`);

        button.disabled = true;
        showSpinner(cacheType);
        resultsDiv.innerHTML = '<p>Benchmark in progress...</p>';

        try {
            const response = await fetch('/api/benchmark/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    numberOfRequests: parseInt(requestsInput.value),
                    cacheType: cacheType
                })
            });
            const data = await response.json();
            displayResults(data, cacheType);
        } catch (error) {
            resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        } finally {
            button.disabled = false;
            hideSpinner(cacheType);
        }
    }

    async function runCombinedBenchmark() {
        const combinedButton = document.getElementById('combinedButton');
        combinedButton.disabled = true;
        showSpinner('combined');

        try {
            // Run Redis benchmark first
            await runBenchmark('redis');
            // Then run Hazelcast benchmark
            await runBenchmark('hazelcast');
        } finally {
            combinedButton.disabled = false;
            hideSpinner('combined');
        }
    }

    function displayResults(data, cacheType) {
        const resultsDiv = document.getElementById(`${cacheType}Results`);
        const metricsHtml = `
                <h3>Summary</h3>
                <div class="metrics">
                    <div class="metric-card">
                        <h4>OAuth Requests</h4>
                        <p>Average: ${data.avgOAuthTime.toFixed(2)}ms</p>
                        <p>Min: ${data.minOAuthTime.toFixed(2)}ms</p>
                        <p>Max: ${data.maxOAuthTime.toFixed(2)}ms</p>
                        <p>95th Percentile: ${data.p95OAuthTime.toFixed(2)}ms</p>
                    </div>
                    <div class="metric-card">
                        <h4>Resource Requests</h4>
                        <p>Average: ${data.avgResourceTime.toFixed(2)}ms</p>
                        <p>Min: ${data.minResourceTime.toFixed(2)}ms</p>
                        <p>Max: ${data.maxResourceTime.toFixed(2)}ms</p>
                        <p>95th Percentile: ${data.p95ResourceTime.toFixed(2)}ms</p>
                    </div>
                    <div class="metric-card">
                        <h4>Success Rate</h4>
                        <p>Total Requests: ${data.totalRequests}</p>
                        <p>Successful: ${data.successfulRequests}</p>
                        <p>Failed: ${data.failedRequests}</p>
                        <p>Success Rate: ${((data.successfulRequests / data.totalRequests) * 100).toFixed(2)}%</p>
                    </div>
                </div>
            `;
        resultsDiv.innerHTML = metricsHtml;
        updateChart(data, cacheType);
    }

    function updateChart(data, cacheType) {
        const ctx = document.getElementById(`${cacheType}Chart`).getContext('2d');

        // Destroy existing chart if it exists
        if (charts[cacheType]) {
            charts[cacheType].destroy();
        }

        const successfulResults = data.results.filter(r => r.success);

        charts[cacheType] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: successfulResults.map(r => r.requestNumber),
                datasets: [
                    {
                        label: 'OAuth Request Time',
                        data: successfulResults.map(r => r.oauthRequestTime),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    },
                    {
                        label: 'Resource Request Time',
                        data: successfulResults.map(r => r.resourceRequestTime),
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Time (ms)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Request Number'
                        }
                    }
                }
            }
        });
    }
</script>
</body>
</html>